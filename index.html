<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador |WA|</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #10b981; --dark: #064e3b; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; --card: #fff; --radius: 12px; --blue: #3b82f6; }
        body.dark-mode { --bg: #111827; --text: #f9fafb; --card: #1f2937; --primary: #059669; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; transition: 0.3s; }
        .container { max-width: 900px; margin: 0 auto; background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #e5e7eb; border-radius: var(--radius); font-family: inherit; background: #f9fafb; color: #333; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary); background: #fff; }
        body.dark-mode input, body.dark-mode textarea { background: #374151; color: white; border-color: #4b5563; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: var(--radius); background: var(--primary); color: white; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        button:hover { filter: brightness(0.9); transform: translateY(-1px); }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .secondary { background: #e5e7eb; color: #333; }
        .danger { background: var(--danger); }
        .btn-auto { width: auto !important; padding: 6px 12px; font-size: 12px; margin: 2px; flex-shrink: 0; }
        
        .card { background: var(--card); border: 1px solid #e5e7eb; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; border-radius: var(--radius); align-items: center; gap: 10px; overflow: hidden; }
        .link-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px; }
        
        /* Modal & Utilities */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(2px); }
        .modal-content { background:var(--card); padding:25px; border-radius:20px; width:95%; max-width:550px; position:relative; color: var(--text); max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Loader */
        .loader { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .theme-toggle { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white; border: none; z-index: 999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>

    <div class="container">
        <div id="login-screen" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <div style="background: var(--primary); width: 70px; height: 70px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 35px; color: white;">‚ö°</div>
            <h2 style="font-weight: 700; margin-bottom: 5px;">Gerenciador |WA|</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 25px;">Acesso Seguro & Criptografado</p>
            
            <input type="text" id="user" placeholder="Usu√°rio" autocomplete="off">
            <input type="password" id="pass" placeholder="Senha">
            
            <button onclick="fazerLogin()" id="btn-login">
                <span class="btn-text">Entrar no Sistema</span>
                <div class="loader" id="login-loader"></div>
            </button>
            
            <p id="msg-login" style="color: var(--danger); font-size: 13px; margin-top: 15px; font-weight: 600; min-height: 20px;"></p>
            <button onclick="window.open('https://wa.me/5521970458286')" class="secondary btn-auto" style="margin-top:20px; background: transparent; border: 1px solid #ccc;">üí¨ Suporte T√©cnico</button>
        </div>

        <div id="app-screen" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <div>
                    <h3 id="ola-user" style="margin:0; font-size: 18px;">...</h3>
                    <small id="status-acesso" style="color: #666;"></small>
                </div>
                <div style="text-align: right;">
                    <button id="btn-admin" class="btn-auto hidden" style="background: #333; margin-bottom: 5px;" onclick="abrirAdmin()">‚öôÔ∏è Admin</button>
                    <button onclick="logout()" class="danger btn-auto">Sair</button>
                </div>
            </div>

            <div id="vencimento-alert" class="card" style="background: #fff7ed; border-color: #fdba74; display: none;">
                <span style="font-size: 12px; color: #c2410c;">‚ö†Ô∏è Acesso expira em <b id="dias-restantes">0</b> dias.</span>
                <button onclick="abrirModalRenovar()" class="btn-auto" style="background: #f97316;">Renovar</button>
            </div>

            <div style="background: rgba(0,0,0,0.02); padding: 15px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid #e5e7eb;">
                <textarea id="links-input" rows="2" placeholder="Cole sua lista de n√∫meros ou links aqui..."></textarea>
                <div style="display: flex; gap: 8px;">
                    <button onclick="carregarLinks()" class="btn-auto">üì• Carregar Lista</button>
                    <button onclick="document.getElementById('file-up').click()" class="secondary btn-auto">üìÇ TXT</button>
                    <input type="file" id="file-up" hidden accept=".txt" onchange="lerArquivo(this)">
                </div>
            </div>

            <div class="card" style="background: #e0f2fe; border-color: #bae6fd;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: #0369a1; font-weight: bold; font-size: 13px;">‚è±Ô∏è Timer (seg):</span>
                    <input type="number" id="auto-timer" value="5" style="width: 60px; text-align: center; margin:0; padding: 5px;">
                    <span id="countdown" style="color: var(--danger); font-weight: bold; width: 40px;"></span>
                </div>
                <button id="btn-auto" onclick="toggleAuto()" class="btn-auto" style="background: #0ea5e9;">‚ñ∂ Iniciar</button>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <div>
                    <h4 style="color: var(--primary); margin-top:0;">Pendentes (<span id="qtd-pend">0</span>)</h4>
                    <div id="lista-pendentes"></div>
                </div>
                <div>
                    <h4 style="color: var(--blue); margin-top:0;">Finalizados (<span id="qtd-salv">0</span>)</h4>
                    <div style="margin-bottom: 10px;">
                         <button onclick="baixarSalvos()" class="secondary btn-auto" style="font-size:10px;">Baixar TXT</button>
                         <button onclick="limparSalvos()" class="danger btn-auto" style="font-size:10px;">Limpar</button>
                    </div>
                    <div id="lista-salvos"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-renovar" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-content" style="text-align: center;">
            <h3 style="color: var(--primary);">Renovar Acesso</h3>
            <div style="background: #ecfdf5; padding: 15px; border-radius: 10px; border: 1px dashed #10b981; margin: 20px 0;">
                <p style="font-size: 12px; margin: 0; color: #065f46;">CHAVE PIX</p>
                <p id="pix-key" style="font-family: monospace; word-break: break-all; font-weight: bold; margin-top: 5px;">...</p>
            </div>
            <button onclick="copiarPix()" style="border-radius: 50px;">üìã Copiar Chave</button>
            <p onclick="document.getElementById('modal-renovar').style.display='none'" style="margin-top:10px; font-size:11px; cursor:pointer; color:#666">Fechar</p>
        </div>
    </div>

    <div id="modal-admin" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Painel Master</h3>
                <button onclick="document.getElementById('modal-admin').style.display='none'" class="danger btn-auto" style="width: auto;">X</button>
            </div>
            <div id="admin-list" style="margin-top: 15px; max-height: 400px; overflow-y: auto;">Carregando...</div>
        </div>
    </div>

    <script>
        // --- CONEX√ÉO COM SEU BACKEND NO GOOGLE ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbzPZF_g41r5zs4rzO9qj4S8iBhwGk7pVEkhrH9pLgVSoZOd5GpWkJH8eNiQ6YodJ10dbg/exec';
        
        const STORAGE_KEY = 'zapflow_user_v2';
        const DB_KEY = 'zapflow_data_v2';
        
        let currentUser = null;
        let localData = { pendentes: [], salvos: [] };
        let autoInterval = null;
        let countdownRef = null;

        // Inicializa√ß√£o
        window.onload = () => {
            if(localStorage.getItem('theme') === 'dark') toggleTheme();
            const savedUser = JSON.parse(localStorage.getItem(STORAGE_KEY));
            const savedData = JSON.parse(localStorage.getItem(DB_KEY));
            
            if(savedData) localData = savedData;
            
            if(savedUser) {
                document.getElementById('user').value = savedUser.user;
                // Valida√ß√£o de sess√£o offline para UX r√°pida
                validarSessao(savedUser);
            }
        };

        // --- SISTEMA DE LOGIN SEGURO (VIA API) ---
        async function fazerLogin() {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();
            const btn = document.getElementById('btn-login');
            const msg = document.getElementById('msg-login');
            const loader = document.getElementById('login-loader');
            
            if(!u || !p) return msg.innerText = "Preencha todos os campos.";
            
            // UI Loading
            btn.querySelector('.btn-text').style.display = 'none';
            loader.style.display = 'block';
            btn.disabled = true;
            msg.innerText = "";

            try {
                // Chama a API no Google (Backend)
                const req = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', user: u, pass: p })
                });
                const res = await req.json();

                if(res.success) {
                    currentUser = res.data;
                    currentUser.pass = p; // Guarda senha local apenas para revalida√ß√£o admin
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({user: u, pass: p, data: currentUser}));
                    entrarNoApp();
                } else {
                    msg.innerText = res.message || "Erro de acesso.";
                }
            } catch(e) {
                msg.innerText = "Erro de conex√£o. Tente novamente.";
                console.error(e);
            } finally {
                btn.querySelector('.btn-text').style.display = 'block';
                loader.style.display = 'none';
                btn.disabled = false;
            }
        }

        function validarSessao(savedUser) {
            // Verifica data localmente primeiro para UX r√°pida
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            const dataVenc = parseData(savedUser.data.date);
            
            // Se j√° expirou h√° muito tempo (mais de 1 dia), remove sess√£o e pede login
            const diff = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
            
            if(diff < -1 && !savedUser.data.isMaster) {
                localStorage.removeItem(STORAGE_KEY);
                return;
            }
            
            currentUser = savedUser.data;
            document.getElementById('pass').value = savedUser.pass;
            entrarNoApp();
        }

        function entrarNoApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            document.getElementById('ola-user').innerText = `Ol√°, ${currentUser.user}`;
            document.getElementById('status-acesso').innerText = `Plano: ${currentUser.val}`;
            
            // C√°lculo de dias para alerta
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            const dataVenc = parseData(currentUser.date);
            const diff = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));

            if(diff <= 5 && !currentUser.isMaster) {
                document.getElementById('vencimento-alert').style.display = 'flex';
                document.getElementById('dias-restantes').innerText = diff < 0 ? 0 : diff;
            }

            if(currentUser.isMaster) {
                document.getElementById('btn-admin').classList.remove('hidden');
            }
            
            renderizarListas();
        }

        // --- CORE DO SISTEMA ---
        function carregarLinks() {
            const txt = document.getElementById('links-input').value;
            if(!txt.trim()) return;
            const linhas = txt.split(/[\r\n,]+/);
            linhas.forEach(l => {
                const limpo = l.trim();
                if(limpo) localData.pendentes.push(limpo);
            });
            document.getElementById('links-input').value = '';
            salvarDados();
            renderizarListas();
        }

        function renderizarListas() {
            const pDiv = document.getElementById('lista-pendentes');
            const sDiv = document.getElementById('lista-salvos');
            
            document.getElementById('qtd-pend').innerText = localData.pendentes.length;
            document.getElementById('qtd-salv').innerText = localData.salvos.length;
            
            pDiv.innerHTML = localData.pendentes.map((l, i) => `
                <div class="card">
                    <span class="link-text">${l}</span>
                    <button class="btn-auto" onclick="abrirLink(${i})">Abrir ‚Üó</button>
                </div>
            `).join('');
            
            // Mostra apenas os √∫ltimos 50 visualmente para n√£o travar em listas gigantes
            sDiv.innerHTML = localData.salvos.slice(0, 50).map((l) => `
                <div class="card" style="border-left: 3px solid var(--primary);">
                    <span class="link-text">${l}</span>
                </div>
            `).join(''); 
        }

        function abrirLink(idx) {
            const link = localData.pendentes[idx];
            let urlFinal = link;
            
            // L√≥gica inteligente de link
            if(!link.includes('http')) {
                // Remove tudo que n√£o √© n√∫mero
                const num = link.replace(/\D/g,'');
                // Se parecer um n√∫mero v√°lido, formata para WhatsApp
                if(num.length >= 8) urlFinal = `https://wa.me/55${num}`;
            }
            
            window.open(urlFinal, '_blank');
            
            // Move para salvos
            localData.salvos.unshift(link); // Adiciona no topo
            localData.pendentes.splice(idx, 1);
            salvarDados();
            renderizarListas();
        }

        // --- AUTOMA√á√ÉO (ROBUST MODE) ---
        function toggleAuto() {
            const btn = document.getElementById('btn-auto');
            if(autoInterval) {
                clearInterval(autoInterval); clearInterval(countdownRef);
                autoInterval = null;
                btn.innerText = "‚ñ∂ Iniciar";
                btn.style.background = "#0ea5e9";
                document.getElementById('countdown').innerText = "";
                return;
            }
            
            if(localData.pendentes.length === 0) return alert("Lista vazia!");
            
            const tempo = parseInt(document.getElementById('auto-timer').value);
            if(tempo < 1) return alert("Tempo inv√°lido");
            
            btn.innerText = "‚èπ Parar";
            btn.style.background = "#ef4444";
            
            processarAuto(tempo);
        }

        function processarAuto(tempo) {
            if(localData.pendentes.length === 0) {
                toggleAuto();
                return alert("Finalizado!");
            }
            
            abrirLink(0);
            
            let count = tempo;
            document.getElementById('countdown').innerText = count;
            
            countdownRef = setInterval(() => {
                count--;
                document.getElementById('countdown').innerText = count;
                if(count <= 0) clearInterval(countdownRef);
            }, 1000);
            
            autoInterval = setTimeout(() => {
                processarAuto(tempo);
            }, tempo * 1000);
        }

        // --- ADMIN / MASTER ---
        async function abrirAdmin() {
            document.getElementById('modal-admin').style.display = 'flex';
            const div = document.getElementById('admin-list');
            div.innerHTML = '<div class="loader" style="display:block; margin: 20px auto; border-color: #333; border-top-color: transparent;"></div>';
            
            try {
                const req = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: 'master', 
                        user: currentUser.user, 
                        pass: document.getElementById('pass').value 
                    })
                });
                const res = await req.json();
                
                if(res.success) {
                    if(res.list.length === 0) {
                        div.innerHTML = "<p style='text-align:center'>Nenhum usu√°rio encontrado.</p>";
                        return;
                    }

                    div.innerHTML = res.list.map(u => {
                        const hj = new Date(); hj.setHours(0,0,0,0);
                        const dv = parseData(u.date);
                        const diff = Math.ceil((dv - hj)/(1000*60*60*24));
                        const cor = diff < 0 ? '#ef4444' : '#10b981';
                        const textoStatus = diff < 0 ? 'Expirado' : `${diff} dias`;
                        
                        return `
                        <div style="background: #f9fafb; padding: 12px; margin-bottom: 8px; border-radius: 10px; border: 1px solid #e5e7eb;">
                            <div style="font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-size: 14px;">${u.user}</span>
                                <span style="color:${cor}; font-size: 11px; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px;">${textoStatus}</span>
                            </div>
                            <div style="font-size:11px; color:#666; margin-top:6px; display:grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                <span>üîë ${u.pass}</span>
                                <span>üì± ${u.wa}</span>
                                <span>üìÖ ${u.date}</span>
                                <span>üí∞ ${u.val}</span>
                            </div>
                            <div style="margin-top:8px; border-top: 1px solid #eee; padding-top: 5px;">
                                <button class="btn-auto secondary" onclick="window.open('https://wa.me/55${u.wa.replace(/\D/g,'')}?text=Ol√° ${u.user}, seus dados de acesso:%0AUsu√°rio: ${u.user}%0ASenha: ${u.pass}%0AVencimento: ${u.date}')">Enviar Dados no WhatsApp</button>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    div.innerHTML = `<p style="color:red; text-align:center">${res.message || "Erro ao carregar."}</p>`;
                }
            } catch(e) {
                div.innerHTML = "<p style='color:red; text-align:center'>Erro de conex√£o com o servidor.</p>";
            }
        }

        // --- UTILIT√ÅRIOS ---
        function salvarDados() { localStorage.setItem(DB_KEY, JSON.stringify(localData)); }
        
        function lerArquivo(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('links-input').value = e.target.result;
                carregarLinks();
            };
            reader.readAsText(file);
        }
        
        function baixarSalvos() {
            if(!localData.salvos.length) return alert("Nada para baixar.");
            const blob = new Blob([localData.salvos.join('\n')], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'lista_finalizada.txt';
            a.click();
        }
        
        function limparSalvos() {
            if(confirm('Limpar hist√≥rico de finalizados?')) {
                localData.salvos = [];
                salvarDados();
                renderizarListas();
            }
        }
        
        function logout() { localStorage.removeItem(STORAGE_KEY); location.reload(); }
        
        function parseData(dateString) {
            if(!dateString) return new Date();
            const s = String(dateString).trim().replace(/['"]/g, '');
            // Se vier como DD/MM/AAAA (padr√£o planilha BR)
            if(s.includes('/')) {
                const parts = s.split('/');
                // New Date aceita (Ano, M√™s-1, Dia)
                return new Date(parts[2], parts[1]-1, parts[0]);
            }
            // Se vier ISO ou outro formato padr√£o
            return new Date(s);
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            document.querySelector('.theme-toggle').innerText = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        }
        
        function abrirModalRenovar() {
            document.getElementById('pix-key').innerText = currentUser.pix;
            document.getElementById('modal-renovar').style.display = 'flex';
        }
        
        function copiarPix() {
            const t = document.getElementById('pix-key').innerText;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(t).then(() => alert("Chave PIX copiada!"), () => alert("Erro ao copiar."));
            } else {
                // Fallback para celulares antigos
                const el = document.createElement('textarea');
                el.value = t;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                alert("Chave PIX copiada!");
            }
        }
    </script>
</body>
</html>
