// =========================================================
//  BACKEND V42 - CORREÇÃO DE DOWNLOAD (FALLBACK INTELIGENTE)
// =========================================================

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Usuarios");
  if (!sheet) sheet = ss.getSheets()[0];

  var dados = JSON.parse(e.postData.contents);
  var action = dados.action;
  var response = { success: false, msg: "Ação desconhecida." };

  // =========================================================
  //  LOGIN (ENTREGA O ARQUIVO GARANTIDO)
  // =========================================================
  if (action == "login") {
    var user = dados.user;
    var pass = dados.pass;
    var data = sheet.getDataRange().getValues();
    var found = false;
    var userData = {};

    for (var i = 1; i < data.length; i++) {
      if (String(data[i][0]).toLowerCase() == String(user).toLowerCase() && String(data[i][1]) == String(pass)) {
        
        if (data[i][7] == "Bloqueado") {
          return outputJSON({ success: false, msg: "Conta bloqueada." });
        }

        var scriptProps = PropertiesService.getScriptProperties();
        var savedMsg = scriptProps.getProperty('GLOBAL_MSG') || "";
        var savedTut = scriptProps.getProperty('TUTORIAL_DATA');
        var tutorialConfig = savedTut ? JSON.parse(savedTut) : []; 
        
        // --- LÓGICA DE ARQUIVO (CORRIGIDA) ---
        var cargoUsuario = data[i][5]; 
        var fileJson = null;

        // 1. Tenta pegar os arquivos salvos
        var rawTeste = scriptProps.getProperty('FILE_DATA_TESTE');
        var rawGeral = scriptProps.getProperty('FILE_DATA_GERAL');
        
        // Fallback para versão antiga se não achar o novo Geral
        if (!rawGeral) { rawGeral = scriptProps.getProperty('FILE_DATA'); }

        if (cargoUsuario === 'Teste') {
            // Se for Teste, tenta o arquivo de teste. SE NÃO TIVER, entrega o Geral.
            if (rawTeste) {
                fileJson = JSON.parse(rawTeste);
            } else if (rawGeral) {
                fileJson = JSON.parse(rawGeral); // Fallback: entrega o geral
            }
        } else {
            // Usuários normais e Admins recebem o Geral
            if (rawGeral) {
                fileJson = JSON.parse(rawGeral);
            }
        }

        userData = {
          user: data[i][0],
          pass: data[i][1],
          date: formatarData(data[i][2]),
          wa: data[i][3],
          val: data[i][4],
          cargo: cargoUsuario, 
          pix: data[i][6],
          isMaster: (String(cargoUsuario).toLowerCase() === "admin"),
          message: savedMsg,
          tutorialConfig: tutorialConfig,
          file: fileJson // Aqui vai o arquivo encontrado
        };
        found = true;
        break;
      }
    }

    if (found) {
      return outputJSON({ success: true, data: userData });
    } else {
      return outputJSON({ success: false, msg: "Dados incorretos." });
    }
  }

  // =========================================================
  //  UPLOAD (Google Drive)
  // =========================================================
  if (action == "upload_file") {
    if (!verificarCredenciais(sheet, dados.user, dados.pass)) return outputJSON({success:false});
    
    try {
      var folderName = "ZapFlow_Arquivos";
      var folders = DriveApp.getFoldersByName(folderName);
      var folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);

      var decoded = Utilities.base64Decode(dados.fileData);
      var blob = Utilities.newBlob(decoded, dados.fileType || "text/plain", dados.fileName);
      var file = folder.createFile(blob);
      
      // Garante permissão pública
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      
      var fileInfo = {
        url: file.getDownloadUrl(),
        time: new Date().toLocaleString("pt-BR"),
        name: dados.fileName,
        type: dados.mode
      };

      var saveKey = (dados.mode === 'teste') ? 'FILE_DATA_TESTE' : 'FILE_DATA_GERAL';
      PropertiesService.getScriptProperties().setProperty(saveKey, JSON.stringify(fileInfo));

      return outputJSON({ success: true, url: fileInfo.url });
    } catch(e) {
      return outputJSON({ success: false, msg: e.toString() });
    }
  }

  // --- DEMAIS FUNÇÕES (Mantidas iguais para economizar espaço, mas necessárias) ---
  if (action == "update_tutorial_list") {
    if (!verificarCredenciais(sheet, dados.user, dados.pass, true)) return outputJSON({ success: false });
    var p = PropertiesService.getScriptProperties();
    if (!dados.listaTutoriais || dados.listaTutoriais.length === 0) p.deleteProperty('TUTORIAL_DATA'); else p.setProperty('TUTORIAL_DATA', JSON.stringify(dados.listaTutoriais));
    return outputJSON({ success: true });
  }
  if (action == "admin_list") {
    if (!verificarCredenciais(sheet, dados.user, dados.pass)) return outputJSON({ success: false });
    var rows = sheet.getDataRange().getValues(), list = [], reqUser = dados.user, reqCargo = getCargo(sheet, reqUser);
    for (var i = 1; i < rows.length; i++) {
      if (reqCargo === 'Admin' || rows[i][8] === reqUser || rows[i][0] === reqUser) { rows[i][2] = formatarData(rows[i][2]); list.push(rows[i]); }
    }
    return outputJSON({ success: true, list: list });
  }
  if (action == "create_user") {
    if (!verificarCredenciais(sheet, dados.user, dados.pass)) return outputJSON({ success: false, msg:"Sem Permissão" });
    if (userExists(sheet, dados.novoUsuario.user)) return outputJSON({ success: false, msg: "Existe" });
    var n = dados.novoUsuario; sheet.appendRow([n.user, n.pass, n.date, n.wa, n.val, n.cargo, n.pix, "Ativo", dados.user, ""]);
    return outputJSON({ success: true });
  }
  if (action == "edit_user") {
    var r = findUserRow(sheet, dados.dadosEditados.userOriginal);
    if (r > 0) { var e = dados.dadosEditados; sheet.getRange(r, 2).setValue(e.pass); sheet.getRange(r, 3).setValue(e.date); sheet.getRange(r, 4).setValue(e.wa); sheet.getRange(r, 5).setValue(e.val); return outputJSON({ success: true }); }
    return outputJSON({ success: false });
  }
  if (action == "renew_user") {
    var r = findUserRow(sheet, dados.targetUser);
    if (r > 0) { var base = new Date(), curr = sheet.getRange(r, 3).getValue(); if(curr instanceof Date && curr > base) base = curr; base.setDate(base.getDate() + parseInt(dados.days)); var y=base.getFullYear(), m=("0"+(base.getMonth()+1)).slice(-2), d=("0"+base.getDate()).slice(-2); sheet.getRange(r, 3).setValue(`${d}/${m}/${y}`); sheet.getRange(r, 8).setValue("Ativo"); return outputJSON({ success: true }); }
    return outputJSON({ success: false });
  }
  if (action == "toggle_status") {
    var r = findUserRow(sheet, dados.targetUser); if (r > 0) { var c = sheet.getRange(r, 8); c.setValue(c.getValue()==="Ativo"?"Bloqueado":"Ativo"); return outputJSON({ success: true }); } return outputJSON({ success: false });
  }
  if (action == "save_message") {
    if (!verificarCredenciais(sheet, dados.user, dados.pass, true)) return outputJSON({success:false}); PropertiesService.getScriptProperties().setProperty('GLOBAL_MSG', dados.message); return outputJSON({ success: true });
  }

  return outputJSON(response);
}

function outputJSON(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }
function formatarData(v) { if (v instanceof Date) { var d = ("0" + v.getDate()).slice(-2), m = ("0" + (v.getMonth()+1)).slice(-2), y = v.getFullYear(); return `${d}/${m}/${y}`; } return v; }
function verificarCredenciais(s, u, p, a) { var d = s.getDataRange().getValues(); for (var i = 1; i < d.length; i++) { if (String(d[i][0]).toLowerCase() == String(u).toLowerCase() && String(d[i][1]) == String(p)) { if (a && String(d[i][5]).toLowerCase() !== 'admin') return false; return true; } } return false; }
function getCargo(s, u) { var d = s.getDataRange().getValues(); for (var i = 1; i < d.length; i++) { if (String(d[i][0]).toLowerCase() == String(u).toLowerCase()) return d[i][5]; } return "User"; }
function userExists(s, u) { var d = s.getDataRange().getValues(); for (var i = 1; i < d.length; i++) { if (String(d[i][0]).toLowerCase() == String(u).toLowerCase()) return true; } return false; }
function findUserRow(s, u) { var d = s.getDataRange().getValues(); for (var i = 1; i < d.length; i++) { if (String(d[i][0]).toLowerCase() == String(u).toLowerCase()) return i + 1; } return -1; }
