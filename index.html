<div id="modal-admin" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="fecharModal('modal-admin')">&times;</span>
        <h2 style="color: var(--dark); margin:0 0 15px 0;">丘뙖잺 Painel Master</h2>
        <button onclick="window.open('https://docs.google.com/spreadsheets/d/1zoUz8WEiulTm2r2VYAxbiq6yy8EROFbKrx6EPjppsyI/edit?gid=0#gid=0', '_blank')" class="sheet-btn">游늭 Abrir Google Sheets</button>
        <div id="admin-users-list" style="max-height: 400px; overflow-y: auto;">Carregando usu치rios...</div>
    </div>
</div>

<div id="modal-edit-user" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="fecharModal('modal-edit-user')">&times;</span>
        <h3>九勇 Editar Usu치rio</h3>
        <label>Usu치rio</label><input type="text" id="edit-name">
        <label>Senha</label><input type="text" id="edit-pass">
        
        <div style="display: flex; gap: 10px;">
            <div style="flex:1;">
                <label>WhatsApp</label>
                <input type="text" id="edit-wa" placeholder="Ex: 21970458286">
            </div>
            <div style="flex:1;">
                <label>Valor R$</label>
                <input type="text" id="edit-val" placeholder="0.00">
            </div>
        </div>

        <label>Validade</label>
        <input type="date" id="edit-date">
        
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onclick="somarDiasEdicao(30)" class="secondary btn-auto">+30 Dias</button>
            <button onclick="somarDiasEdicao(15)" class="secondary btn-auto">+15 Dias</button>
        </div>

        <button onclick="copiarLinhaPlanilha()" class="admin-btn">游 Gerar Linha Planilha</button>
        <div id="manual-copy-box" class="copy-box"></div>
    </div>
</div>

<script>
    // Atualize as fun칞칫es abaixo no seu <script>

    function abrirAdminPanel() {
        document.getElementById('modal-admin').classList.add('show');
        const lista = document.getElementById('admin-users-list');
        lista.innerHTML = '';

        adminCache.forEach((u, idx) => {
            if(u.user.toLowerCase() === 'admin') return;

            // Limpa o n칰mero de WhatsApp para o link
            const zapLimpo = u.wa ? u.wa.replace(/\D/g,'') : "";
            
            const div = document.createElement('div');
            div.className = 'user-row';
            div.innerHTML = `
                <div class="user-head">
                    <div>
                        <strong>${u.user}</strong> 
                        ${u.val ? `<span class="value-badge" style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:10px; font-size:10px; margin-left:5px;">R$ ${u.val}</span>` : ''}
                    </div>
                    <span style="font-size:12px; color:#666;">${u.date}</span>
                </div>
                <div class="user-actions">
                    ${zapLimpo ? `<button class="chat-btn btn-auto" style="background:#25d366; color:white;" onclick="window.open('https://wa.me/55${zapLimpo}')">游눫</button>` : ''}
                    <button class="edit-btn btn-auto" style="background:#3b82f6; color:white;" onclick="prepararEdicao(${idx})">九勇 Editar</button>
                </div>`;
            lista.appendChild(div);
        });
    }

    function prepararEdicao(idx) {
        const u = adminCache[idx];
        document.getElementById('edit-name').value = u.user;
        document.getElementById('edit-pass').value = u.pass;
        document.getElementById('edit-wa').value = u.wa || '';
        document.getElementById('edit-val').value = u.val || '';
        
        // Converte data BR (DD/MM/AAAA) para formato do Input Date (AAAA-MM-DD)
        const partes = u.date.split('/');
        if(partes.length === 3) {
            document.getElementById('edit-date').value = `${partes[2]}-${partes[1]}-${partes[0]}`;
        }
        
        fecharModal('modal-admin');
        document.getElementById('modal-edit-user').classList.add('show');
    }

    function copiarLinhaPlanilha() {
        const n = document.getElementById('edit-name').value;
        const p = document.getElementById('edit-pass').value;
        const w = document.getElementById('edit-wa').value;
        const v = document.getElementById('edit-val').value;
        const d = document.getElementById('edit-date').value.split('-').reverse().join('/');
        
        // Formato exato da planilha: Usu치rio, Senha, Data, WhatsApp, Valor
        const csv = `${n},${p},${d},${w},${v}`;
        
        const box = document.getElementById('manual-copy-box');
        box.innerText = csv;
        box.style.display = 'block';
        
        navigator.clipboard.writeText(csv).then(() => {
            alert("Copiado! Basta colar na sua planilha do Google.");
        });
    }
</script>
